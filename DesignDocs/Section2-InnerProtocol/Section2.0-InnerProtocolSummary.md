# 内部通信协议

## 综述

### 协议目的

1. 协调评测机和控制端的通信。

2. 验证评测机和控制端的身份，防止恶意攻击

3. 兼容缓存机制的运行

## 名称解释

### 控制端的RSA公钥

控制端的RSA公钥，由管理员填入评测机的配置文件中。

### 控制端的RSA私钥

控制端的RSA私钥，由控制端保管，需严格防止外泄。

### 评测机端的RSA私钥

评测机端的RSA私钥。由控制端生成，与密钥编号相关联。由管理员填入评测机的配置文件中。如不慎泄密或失密，应使用控制端的管理功能注销对应的密钥对。

### 评测机端的RSA公钥

评测机的RSA公钥，由控制端生成并保存。不必人工读取，亦无保密必要。

### 评测机端的密钥编号

用于识别不同的评测机及其密钥，无保密必要

### 会话令牌

评测机与控制端认证成功后协商的会话令牌，用于加密会话内容。

### 任务令牌

流量控制系统的组成部分。令牌与评测机关联。向评测机下发任务需占用一个对应评测机的任务令牌并登记到活动任务令牌队列中。当评测结束并返回后，释放任务令牌至可用池中。

### `JudgerID`

认证成功后发送给评测机用于区别身份的整数

## 组成部分

对于没有收到下一步的回应的情况，采用指数退避算法至多重发 5 次

对于只需简单返回 ack 的情况，即使重复收到消息，亦应为每个消息单独返回 ack

### 身份验证协议

#### 身份验证协议前提

##### 身份验证协议评测机端

- 配置文件写入控制端的RSA公钥

- 配置文件写入评测机端的RSA私钥和密钥编号

- 配置文件写入评测机地址

##### 身份验证协议控制端

- 记录发放的评测机的公钥和密钥编号

#### 身份验证协议内容

1. 评测机发起 `WebSocket` 链接（使用tls协议提供基本安全性）

2. 评测机将随机的选取大整数和密钥编号，使用控制端公钥加密后发送。

3. 控制端解密后，将解密的大整数和另一随机选取大整数用密钥编号对应的公钥加密并发送。

4. 评测机用私钥解密，检查返回的大整数是否一致，一致则认为连接上了真实的控制端并将控制端选取的随机整数用控制端公钥加密后发送。

5. 控制端解密后，检查解密的大整数。一致则认为是合法的评测机。发送确认信号和会话令牌。

6. 以后会话使用会话令牌认证

- 如任意一步失败（包括没有收到回应），则主动断开连接，协议终止。

### 评测准备协议

此协议应当在认证后立即进行，可以认为 `JudgerReadme` 是对发放会话令牌的回应

#### 评测准备协议前提

##### 评测准备协议评测机端

1. 已经通过身份认证拿到了会话令牌和 `JudgerID`

##### 评测准备协议控制端

1. 已经通过身份认证发放了会话令牌

#### 评测准备协议内容

- 评测机通过  `WebSocket` 链接向控制端发送如下内容

  `评测机自述字段类型`
  `JudgerReadme`

- 控制端发送确认信号（`Response`）

  - 如未收到该确认信号，评测机应重试，失败 5 次后断开连接

### 心跳协议

#### 心跳协议前提

##### 心跳协议评测机端

1. 已经通过身份认证拿到了会话令牌和 `JudgerID`

##### 心跳协议控制端

1. 已经通过身份认证发放了会话令牌

#### 心跳协议内容

- 评测机通过  `WebSocket` 链接向控制端发送如下内容

  `评测机心跳字段类型`
  `JudgerHeartBeat`

- 控制端发送确认信号（`HeartBeatResponse`）

  - 如未收到该确认信号，评测机应重试，失败 5 次后断开连接

### 评测任务协议

#### 评测任务协议前提

##### 评测任务协议评测机端

1. 已经通过身份认证拿到了会话令牌和 `JudgerID`

##### 评测任务协议控制端

1. 已经通过身份认证发放了会话令牌

2. 已经完成评测准备协议，拿到了任务令牌

#### 评测任务协议内容

- 控制端通过 `WebSocket` 链接向评测机发送如下内容，同时内部登记令牌为发送状态
  - 任务ID是控制端生成的
    可能出现多个任务ID对应一个评测请求的情况（但有效ID只能有一个）

  - 每次发送任务都应当生成任务ID

  `任务字段类型`
  `Task`

- 评测机返回确认（`Response`）

  - 如未收到回应，认为任务发送失败
    - 将任务放回控制端等待队列
    - 作废此次生成的任务ID
    - 释放对应令牌

- 控制端登记令牌为活动状态

  - 无需发送消息

- 当评测机评测结束，向控制端发送 `JudgeResult`

- 控制端接受结果并返回确认（`Response`）

  - 如果存在对应的令牌，确认的状态码为 200 ，并释放该令牌

  - 否则状态码为 302 ，并忽略这一份评测结果（可以打log）
